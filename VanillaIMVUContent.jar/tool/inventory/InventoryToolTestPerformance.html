<!doctype html>
<html>
<head>
    <script src="../../js/jquery-1.6.js"></script>
    <script src="../../js/underscore.js"></script>
<link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" type="text/css" href="../style.css" />
    <link rel="stylesheet" type="text/css" href="../../widgets/button/imvuButton.css" />
    <script src="../../js/prologue.js"></script>

    <script src="../../js/FakeImvu.js"></script>
    <script src="../../js/FakeTimer.js"></script>
    <script src="../../widgets/button/imvuButton.js"></script>
    <script src="InventoryTool.js"></script>
    <script src="FakeProduct.js"></script>
    <script src="FakeInventoryDataSource.js"></script>
    <script src="InventoryDataSource.js"></script>

</head>
<body>
<script>

var PRODUCT_THUMBNAIL_WIDTH = 100;
var PRODUCT_THUMBNAIL_HEIGHT = 80;
var PRODUCT_THUMBNAIL_MARGIN = 2;
var PRODUCT_WIDGET_WIDTH = PRODUCT_THUMBNAIL_WIDTH + (PRODUCT_THUMBNAIL_MARGIN * 2);
var PRODUCT_WIDGET_HEIGHT = PRODUCT_THUMBNAIL_HEIGHT + (PRODUCT_THUMBNAIL_MARGIN * 2);

runTestsWithIframe('index.html?no_js', {
    setUp: function () {
        this.scratch = this.setUpScratch();
        this.rootElement = this.scratch.querySelector('#tool');
        this.fakeImvu = new FakeImvu();
        function getProducts() {
            return [
                {products_id:260, products_image:'img/products/260.png', products_name: 'Female avatar', manufacturers_name: 'IMVU inc.', manufacturers_id: 123, cPath:[1,2,3]},
                {products_id:238924, products_image:'img/products/238924.png', products_name: 'Fire hair', manufacturers_name: 'IMVU inc.', manufacturers_id: 456, cPath:[4,5,6]},
            ];
        }
        this.fakeImvu._respond('countProducts', function () { return 2; });
        this.fakeImvu._respond('getProducts', getProducts);
        this.fakeImvu._respond('hasAccessPass', true);
        this.eventBus = new EventBus(this.fakeImvu);

        this.dataSource = new InventoryDataSource({imvu: this.fakeImvu});
        this.createTool();
        
    },

    createTool: function (spec) {
        spec = spec || {};
        this.tool = new InventoryTool({
            rootElement: this.rootElement,
            imvu: this.fakeImvu,
            dataSource: this.dataSource,
            eventBus: this.eventBus,
            timer: new FakeTimer(),
            mode: spec.mode,            
            shouldShowSaveOutfitButton: spec.shouldShowSaveOutfitButton
        });
    },

    setupPreviousSelections: function (category, gender, maturity, view) {
        this.fakeImvu._respond('getPref', function(pname) {
            if(pname == 'inventoryCategory') return category;
            else if(pname == 'inventoryGender') return gender;
            else if(pname == 'inventoryMaturity') return maturity;
            else if(pname == 'inventoryView') return view;
            else {
                Assert.fail('unexpected pref name '+pname);
            }
        });
    },

    getProductWidgets: function () {
        return this.tool.elInventory.querySelectorAll('.product');
    },

    assertElementIsWidgetForProduct: function (el, product) {
        Assert.isTrue(endsWith(el.querySelector('img').src, product.thumbnail_url));
        Assert.areEqual(el.querySelector('.name').innerHTML, product.name);
        Assert.areEqual(el.title, product.name);
        Assert.areEqual(el.querySelector('.creator>span').innerHTML, product.creator_name);
        Assert.areEqual(el.querySelector('.category').innerHTML, product.category_name);
        Assert.areEqual(el.querySelector('.putOnOrTakeOff').innerHTML, 'Put On');
    },

    assertCanSelectEachFilter: function (elAllFilters) {
        Assert.isTrue(elAllFilters.length > 0);
        for each (var elFilter in elAllFilters) {
            synthesizeClick(elFilter);
            Assert.isTrue($(elFilter).hasClass('selected'));
            for each (var elOtherFilter in elAllFilters) {
                if (elOtherFilter !== elFilter) {
                    Assert.isFalse($(elOtherFilter).hasClass('selected'));
                }
            }
        }
    },
    
    resizeViewport: function (w, h) {
        this.tool.elInventory.style.width = Math.floor(PRODUCT_WIDGET_WIDTH * w) + 'px';
        if (h) {
            this.tool.elInventory.style.height = Math.floor(PRODUCT_WIDGET_HEIGHT * h) + 'px';
        }
    },
    
    test_can_create_tons_of_placeholders_quickly: function () {
        var start = new Date();
        this.tool.createPlaceHolders(30000, 1000);
        var took = new Date() - start;
        Assert.isTrue(took <= 2000, "Inserting 30k placeholders: " + took + "ms > 2s");
    },
    
    test_can_reflow_tons_of_placeholders_quickly: function () {
        var start, self = this;
        function renderHook() {
            self.resume(function () {
                window.removeEventListener('MozAfterPaint', renderHook, false);
                var took = new Date() - start;
                Assert.isTrue(took <= 2000, "Reflowing 30k placeholders: " + took + "ms > 2s. Historical cause: floats (inline-block is much faster)");
            });
        }
        this.tool.createPlaceHolders(30000, 1000);
        start = new Date();
        window.addEventListener('MozAfterPaint', renderHook, false);
        this.wait();
    },
});

</script>
</body>
</html>
