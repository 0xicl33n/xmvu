<!doctype html>
<html>
<head>
<link rel="stylesheet" type="text/css" href="../../widgets/button/imvuButton.css" />
    <link rel="stylesheet" type="text/css" href="invited_to_chat.css">

    <script src="../../js/prologue.js"></script>
    <script src="../../js/FakeImvu.js"></script>
    <script src="../../js/buttons.js" charset="utf-8"></script>
    <script src="../../js/FakeTimer.js"></script>
    <script src="invited_to_chat.js"></script>
</head>
<body>
<script>
function replaceToggle() {
    //jQuery's animation isn't testable; they use setInterval and their code depends
    // on the callback _not_ being called before the setup is done.  However, 
    // triggering all of that from tests turns out to be very hard. 
    var oldToggle = $.fn.toggle;
    $.fn.toggle = function(a, b, c) {
        if (typeof(a) == 'number') {
            oldToggle.bind(this)();
            if (typeof(b) == 'function') {
                b();
            }
        } else {
            oldToggle.bind(this)();
        }
    }

    return function() {
        $.fn.toggle = oldToggle;
    }
    /*
    var oldTimeout = window.setTimeout;
    var oldInterval = window.setInterval;
    var oldClearTimeout = window.clearTimeout;
    var oldClearInterval = window.clearInterval;
    var oldNow = jQuery.now;
    //var oldTime = $.
    
    window.setTimeout = function(callback, delay) {
        callback();
        return 0;
    }

    var intervalCounter = 0;
    window.setInterval = function(callback, delay) {
        for (;intervalCounter < 100; intervalCounter++) {
            callback();
        }
        return 0;
    }
    jQuery.now = function() {
        return oldNow() + (intervalCounter*1000);
    }
    window.clearTimeout = function() {
        intervalCounter = 100;
    }
    
    return function() {
        window.setTimeout = oldTimeout;
        window.setInterval = oldInterval;
        window.clearTimeout = oldClearTimeout;
        window.clearInterval = oldClearInterval;
        jQuery.now = oldNow;
    }
    //*/
}

runTestsWithIframe('index.html?no_js', {
    name : 'ChatInviteTests',

    setUp : function() {
        var scratchDiv = this.setUpScratch();
        this.fakeImvu = new FakeImvu();
        this.fakeTimer = new FakeTimer({autoDispatch: false});
        this.info = {'buttons': [{'grey': 1, 'value': 'IGNORE', 'name': 'IGNORE'}, {'grey': 1, 'value': 'DECLINE', 'name': 'DECLINE'}, {'name': 'ACCEPT', 'value': 'ACCEPT'}],
                     'avInfo': {'gender': 'm',
                                'age': '42',
                                'name': 'Guest_awilcoxtest184',
                                'imageUrl': 'http://foo.jpeg'},
                     'title': 'Someone wants to chat',
                     'location': {'name': 'The Gulag', 
                                  'private': 0, 
                                  'imageUrl': 'http://bar.jpeg', 
                                  'description':'Description', 
                                  'maxOccupancy':10, 
                                  'currentOccupancy':4}};
    },

    test_initialize_info_to_proper_elements: function() {
        this.dialog = new InviteDialog({imvu: this.fakeImvu, info: this.info, timer:this.fakeTimer});
        Assert.areEqual('Someone wants to chat', $('.title h1').text());
        Assert.areEqual('Guest_awilcoxtest184', $('#avname').text());
        Assert.areEqual('http://foo.jpeg', $('#picture-img').attr('src'));
        Assert.areEqual('42', $('#age').text());
        Assert.areEqual('Male', $('#gender').text());

        Assert.areEqual('The Gulag', $('#location .locname').text());
        Assert.isFalse($('#location .is-private').is(':visible'), 'Private should be hidden');
        Assert.isTrue($('#location .is-public').is(':visible'), 'Public should be visible');
        Assert.isTrue($('#location .data').is(':visible'), 'Room data should be visible');
        Assert.areEqual('4 / 10', $('#location .occupancy').text());
        Assert.areEqual('Description', $('#location .description').text());
        Assert.areEqual('url("http://bar.jpeg/")', $('#location .image-wrapper').css('background-image'));

        Assert.isTrue($('#decline-btn').is(':visible'), 'Decline button should be visible');
        Assert.isFalse($('#decline-reason-container').is(':visible'), 'Decline reason should be hidden');
        Assert.isFalse($('#button-bar2').is(':visible'), 'Decline buttons should be hidden');
    },

    test_show_no_room_image_no_imageUrl_present: function() {
        this.info.location.imageUrl = '';
        this.dialog = new InviteDialog({imvu: this.fakeImvu, info: this.info, timer:this.fakeTimer});
        var imageUrl = $('#location .image-wrapper').css('background-image');
        imageUrl = /"(.*)"/.exec(imageUrl)[1];
        imageUrl = imageUrl.split('/').splice(-3).join('/');

        Assert.areEqual('chat_rooms/img/no_image_room.jpg', imageUrl);
    },

    test_private_room: function() {
        this.info.location.private = 1;
        delete this.info.location.description;
        this.dialog = new InviteDialog({imvu: this.fakeImvu, info: this.info, timer:this.fakeTimer});
        Assert.areEqual('The Gulag', $('#location .locname').text());
        Assert.isTrue($('#location .is-private').is(':visible'), 'Private should be visible');
        Assert.isFalse($('#location .is-public').is(':visible'), 'Public should be hidden');
        Assert.isFalse($('#location .text').is(':visible'), 'Data should be hidden');
        Assert.isFalse($('#location .description').is(':visible'), 'description should be hidden');
        Assert.areEqual('url("http://bar.jpeg/")',$('#location .image-wrapper').css('background-image'), 'Room image should be visible');
    },

    test_users_get_unknown_location: function(){
        this.info.location = 'Unknown';

        this.dialog = new InviteDialog({imvu: this.fakeImvu, info: this.info, timer:this.fakeTimer});
        Assert.isFalse($('#location .is-private').is(':visible'), 'private should not be shown');
        Assert.isFalse($('#location .is-public').is(':visible'), 'private should not be shown');
        Assert.areEqual('', $('#location .name').text());
        Assert.isFalse($('#location img').is(':visible'), 'image should not be shown');
        Assert.isFalse($('#location .data').is(':visible'), 'data should not be shown');
        Assert.isFalse($('#location .description').is(':visible'), 'description should not be shown');
    },

    test_clicking_accept_button: function() {
        this.dialog = new InviteDialog({imvu: this.fakeImvu, info: this.info, timer:this.fakeTimer});
        $('#decline-reason').attr('value', 'foo bar baz');
        $('#accept').click();
        Assert.isTrue(this.fakeImvu._wasCalled('endDialog', ['ACCEPT', 'foo bar baz']), 'should have ended the dialog by clicking decline');
    },

    test_clicking_ignore_button: function() {
        this.dialog = new InviteDialog({imvu: this.fakeImvu, info: this.info, timer:this.fakeTimer});
        $('#decline-reason').attr('value', 'foo bar baz');
        $('#ignore').click();
        Assert.isTrue(this.fakeImvu._wasCalled('endDialog', ['IGNORE', 'foo bar baz']), 'should have ended the dialog by clicking ignore');
    },

    test_dialog_times_out_after_30_seconds: function() {
        this.dialog = new InviteDialog({imvu: this.fakeImvu, info: this.info, timer:this.fakeTimer});
        Assert.areEqual(30*1000, this.fakeTimer.timeouts.id_1[1]);
        this.fakeTimer.dispatchAll();
        Assert.isTrue(this.fakeImvu._wasCalled('endDialog', ['TIMEOUT', '']));
    },

    test_closing_dialog_sends_ignore_message: function() {
        this.dialog = new InviteDialog({imvu: this.fakeImvu, info: this.info, timer:this.fakeTimer});
        $('.close').click();
        Assert.isTrue(this.fakeImvu._wasCalled('endDialog', ['IGNORE', '']));
    },

    test_esc_keypress_closes_dialog: function() {
        this.dialog = new InviteDialog({imvu: this.fakeImvu, info: this.info, timer:this.fakeTimer});
        var e = jQuery.Event('keypress');
        e.keyCode = 27;
        $(document).trigger(e);
        Assert.isTrue(this.fakeImvu._wasCalled('endDialog', ['IGNORE', '']));
    },

    test_other_keypress_doesnt_close_dialog: function() {
        this.dialog = new InviteDialog({imvu: this.fakeImvu, info: this.info, timer:this.fakeTimer});
        var e = jQuery.Event('keypress');
        e.keyCode = 67;
        $(document).trigger(e);
        Assert.isFalse(this.fakeImvu._wasCalled('endDialog'));
    }
}, 
{
    name : 'ChatInviteDeclineTests',

    setUp : function() {
        var scratchDiv = this.setUpScratch();
        this.fakeImvu = new FakeImvu();
        this.fakeTimer = new FakeTimer({autoDispatch: false});
        this.info = {'buttons': [{'grey': 1, 'value': 'IGNORE', 'name': 'IGNORE'}, {'grey': 1, 'value': 'DECLINE', 'name': 'DECLINE'}, {'name': 'ACCEPT', 'value': 'ACCEPT'}],
                     'avInfo': {'gender': 'Male',
                                'age': '42',
                                'name': 'Guest_awilcoxtest184',
                                'imageUrl': 'http://foo.jpeg'},
                     'title': 'Someone wants to chat',
                     'location': {'name': 'The Gulag', 'private': 0, 'url': 'http://bar.jpeg', 'description':'Description', 'maxOccupancy':10, 'currentOccupancy':4}};
        this.dialog = new InviteDialog({imvu: this.fakeImvu, info: this.info, timer:this.fakeTimer});
        this.resetToggle = replaceToggle();
    },

    tearDown: function() {
        this.resetToggle();
    },

    test_submitting_decline_form: function() {
        $('#decline-btn').click();
        $('#decline-reason').attr('value', 'shibby shoo');
        $('#decline-reason-container form').submit();
        $('.close').click();
        Assert.isTrue(this.fakeImvu._wasCalled('endDialog', ['DECLINE', 'shibby shoo']));
    },

    test_focus_and_blur_decline_input: function() {
        $('#decline-btn').click();
        $('#decline-reason').focus();
        Assert.isTrue($('#decline-reason-container label').hasClass('hasfocus'));

        $('#decline-reason').blur();
        Assert.isFalse($('#decline-reason-container label').hasClass('hasfocus'));

        $('#decline-reason').focus();
        Assert.isTrue($('#decline-reason-container label').hasClass('hasfocus'));
    },

    test_blur_event_reshows_helper_label: function() {
        $('#decline-btn').click();

        $('#decline-reason').attr('value', 'paradise');
        $('#decline-reason').blur();
        Assert.isTrue($('#decline-reason-container label').hasClass('hasreason'));

        $('#decline-reason').attr('value', '');
        $('#decline-reason').blur();
        Assert.isFalse($('#decline-reason-container label').hasClass('hasreason'));
    },

    test_helper_label_hidden_on_key_event: function() {
        $('#decline-btn').click();
        Assert.isFalse($('#decline-reason-container label').hasClass('hasreason'));

        $('#decline-reason').keydown();
        Assert.isTrue($('#decline-reason-container label').hasClass('hasreason'));
    },

    test_esc_keypress_when_decline_reason_open_cancels_decline: function() {
        $('#decline-btn').click();
        var e = jQuery.Event('keypress');
        e.keyCode = 27;
        $(document).trigger(e);
        Assert.isFalse(this.fakeImvu._wasCalled('endDialog'));
        Assert.isFalse($('#decline-reason').is(':visible'));
        Assert.isTrue ($('#button-bar').is(':visible'));
    },

    test_clicking_cancel_after_decline: function() {
        Assert.isFalse(this.fakeImvu._wasCalled('endDialog', ['DECLINE', 'foo bar baz']), 'decline should not be called yet');
        $('#decline-btn').click();
        Assert.isFalse($('#button-bar').is(':visible'), 'Initial buttons should be hidden');
        Assert.isTrue($('#button-bar2').is(':visible'), 'Decline buttons should be visible');
        Assert.isTrue($('#decline-reason').is(':visible'), 'Decline reason should be visible');
        Assert.isFalse($('#decline-reason-sent').is(':visible'), 'Decline reason sent should be hidden');
        $('#decline-reason').attr('value', 'foo bar baz');
        $('#cancel').click();
        $.fn.toggle = $.fn.oldToggle;
        Assert.isTrue ($('#button-bar').is(':visible'), 'Initial buttons should be visible');
        Assert.isFalse($('#button-bar2').is(':visible'), 'Decline buttons should be hidden');
        Assert.isFalse($('#decline-reason').is(':visible'), 'Decline reason should be hidden');
        Assert.isFalse($('#decline-reason-sent').is(':visible'), 'Decline reason sent should be shown');
    },

    test_clicking_decline_then_closing_dialog: function() {
        Assert.isFalse(this.fakeImvu._wasCalled('endDialog', ['DECLINE', 'foo bar baz']), 'decline should not be called yet');
        $('#decline-btn').click();
        Assert.isFalse($('#button-bar').is(':visible'), 'Initial buttons should be hidden');
        Assert.isTrue($('#button-bar2').is(':visible'), 'Decline buttons should be visible');
        Assert.isTrue($('#decline-reason').is(':visible'), 'Decline reason should be visible');
        Assert.isTrue($('#decline-btn').is(':visible'), 'Decline button should be hidden');
        Assert.isFalse($('#decline-reason-sent').is(':visible'), 'Decline reason sent should be hidden');
        $('#decline-reason').attr('value', 'foo bar baz');
        $('#send').click();
        Assert.isFalse($('#button-bar').is(':visible'), 'Initial buttons should be hidden');
        Assert.isFalse($('#button-bar2').is(':visible'), 'Decline buttons should be hidden');
        Assert.isFalse($('#decline-btn').is(':visible'), 'Decline button should be hidden');
        Assert.isFalse($('#decline-reason').is(':visible'), 'Decline reason should be hidden');
        Assert.isTrue($('#decline-reason-sent').is(':visible'), 'Decline reason sent should be shown');
        Assert.isFalse(this.fakeImvu._wasCalled('endDialog', ['DECLINE', 'foo bar baz']), 'dialog should not be closed yet');
        $('.close').click();
        Assert.isTrue(this.fakeImvu._wasCalled('endDialog', ['DECLINE', 'foo bar baz']), 'dialog should be closed now');
    },

    test_clicking_decline_then_waiting_closes_dialog: function() {
        Assert.isFalse(this.fakeImvu._wasCalled('endDialog', ['DECLINE', 'foo bar baz']), 'decline should not be called yet');
        $('#decline-btn').click();
        Assert.isFalse($('#button-bar').is(':visible'), 'Initial buttons should be hidden');
        Assert.isTrue($('#button-bar2').is(':visible'), 'Decline buttons should be visible');
        Assert.isTrue($('#decline-reason').is(':visible'), 'Decline reason should be visible');
        Assert.isFalse($('#decline-reason-sent').is(':visible'), 'Decline reason sent should be hidden');
        $('#decline-reason').attr('value', 'foo bar baz');
        $('#send').click();
        Assert.isFalse($('#button-bar').is(':visible'), 'Initial buttons should be hidden');
        Assert.isFalse($('#button-bar2').is(':visible'), 'Decline buttons should be hidden');
        Assert.isFalse($('#decline-reason').is(':visible'), 'Decline reason should be hidden');
        Assert.isTrue($('#decline-reason-sent').is(':visible'), 'Decline reason sent should be shown');
        Assert.isFalse(this.fakeImvu._wasCalled('endDialog', ['DECLINE', 'foo bar baz']), 'dialog should not be closed yet');
        this.fakeTimer.dispatchAll();
        Assert.isTrue(this.fakeImvu._wasCalled('endDialog', ['DECLINE', 'foo bar baz']), 'dialog should be closed now');
    },
});

</script>
</body>
</html>
