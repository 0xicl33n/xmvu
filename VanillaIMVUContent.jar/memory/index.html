<html>
  <head>
    <script src="../js/jquery-1.6.js"></script>
    <script src="../js/underscore.js"></script>
<script src="../js/imvu.js"></script>
    <style>
tr {
    background-color: #DDF;
    cursor:default;
}

tr:nth-child(odd) {
    background-color:#FFF;
}

a {
    text-decoration: underline;
    cursor: pointer;
}

#refresh {
    margin: 0 0 1em 0;
}
    </style>
  </head>
  <body>
    <h1>Memory Mode</h1>

    <div id="refresh">
      Last refreshed: <strong id="last_refreshed">???</strong><br/>
      <a href="javascript:refresh()">Refresh</a>
      <input id='auto' type="checkbox" checked>Automatically refresh every 5 seconds</input>
    </div>

    <table>
      <thead><tr>
          <th><a href="javascript:sortByBytes()">Bytes</a></th>
          <th><a href="javascript:sortByAllocations()">Allocations</a></th>
          <th>Stack</th>
      </tr></thead>
      <tbody id='body'>

      </tbody>
    </table>

  </body>

<script>
if (IMVU.runJS()) {
    if (typeof(imvu) !== 'undefined') {

        function getTopStacks(sortBy) {
            return imvu.call('getTopStacks', sortBy);
        }

        function copyStackToClipboard(stack) {
            imvu.call('copyStackToClipboard', stack);
        }

    } else {

        function getTopStacks(sortBy) {
            if (sortBy == 'bytes') {
                return [
                    {bytes: 4500, allocations: 3, stack: '1\n2\n3\n'},
                    {bytes: 2235, allocations: 9, stack: '4\n5\n6\n'},
                    {bytes: 1145, allocations: 5, stack: '7\n8\n9\n'}
                ];
            } else {
                return [
                    {bytes: 2235, allocations: 9, stack: '4\n5\n6\n'},
                    {bytes: 1145, allocations: 5, stack: '7\n8\n9\n'},
                    {bytes: 4500, allocations: 3, stack: '1\n2\n3\n'}
                ];
            }
        }

        function copyStackToClipboard(stack) {
            alert(stack);
        }
    }

    var sortBy = 'bytes';

    function sortByBytes() {
        sortBy = 'bytes';
        refresh();
    }

    function sortByAllocations() {
        sortBy = 'allocations';
        refresh();
    }

    var stacks = []

    function refresh() {
        var html = [];
        stacks = getTopStacks(sortBy);
        for (var i = 0; i < stacks.length; ++i) {
            row = stacks[i];
            html.push('<tr><td>' + row.bytes + '</td><td>' + row.allocations + '</td><td><pre>' + row.stack + '</pre></td><td><a href="javascript:copyStackToClipboard(stacks[' + i + '].stack)">copy</a></td></tr>');
        }
        document.getElementById('body').innerHTML = html.join('');
        document.getElementById('last_refreshed').innerHTML = /\d+:\d+:\d+/.exec(new Date())[0];
    }

    function automaticallyRefresh() {
        elt = document.getElementById('auto');
        if (elt.checked) {
            refresh();
        }
    }

    refresh();
    setInterval(automaticallyRefresh, 5000);
}
</script>
</html>
